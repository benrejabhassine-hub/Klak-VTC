<script>
    let allCoords = { start: null, end: null, stops: {} };
    // Ton lien de groupe remplac√© ici
    const lienGroupe = "https://chat.whatsapp.com/J3zlqfRSAbZ22DTB9re2OQ";

    function addStop() {
        const id = 'stop_' + Date.now();
        const div = document.createElement('div');
        div.className = 'stop-item relative';
        div.innerHTML = `
            <div class="input-wrap">
                <i class="fa-solid fa-ellipsis-vertical text-gray-600 mx-5"></i>
                <input type="text" class="addr-input stop-input" id="${id}" placeholder="Adresse de l'√©tape" data-type="stop">
                <button onclick="deleteStop('${id}', this)" class="pr-4 text-red-500/50"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="suggestion-box"></div>
        `;
        document.getElementById('stopsContainer').appendChild(div);
        initAutocomplete();
    }

    function deleteStop(id, btn) {
        delete allCoords.stops[id];
        btn.parentElement.parentElement.remove();
    }

    function initAutocomplete() {
        document.querySelectorAll('.addr-input').forEach(el => {
            const box = el.parentElement.nextElementSibling;
            el.oninput = async () => {
                if(el.value.length < 3) return;
                const r = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(el.value)}&limit=4`);
                const d = await r.json();
                box.innerHTML = d.features.map(f => `<div class="suggestion-item">${f.properties.label}</div>`).join('');
                box.style.display = 'block';
                box.querySelectorAll('.suggestion-item').forEach((item, i) => {
                    item.onclick = () => {
                        el.value = d.features[i].properties.label;
                        const coords = d.features[i].geometry.coordinates;
                        if(el.dataset.type === 'start') allCoords.start = coords;
                        else if(el.dataset.type === 'end') allCoords.end = coords;
                        else allCoords.stops[el.id] = coords;
                        box.style.display = 'none';
                    };
                });
            };
        });
    }
    initAutocomplete();

    function getDist(c1, c2) {
        if(!c1 || !c2) return 0;
        const deg2rad = d => d * (Math.PI/180);
        const R = 6371;
        const dLat = deg2rad(c2[1]-c1[1]);
        const dLon = deg2rad(c2[0]-c1[0]);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(c1[1])) * Math.cos(deg2rad(c2[1])) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return (R * c) * 1.5; 
    }

    function calculate() {
        if(!allCoords.start || !allCoords.end) return alert("Pr√©cisez les adresses");
        let totalDist = 0;
        let currentPos = allCoords.start;
        const stopInputs = document.querySelectorAll('.stop-input');
        
        stopInputs.forEach(input => {
            const stopCoord = allCoords.stops[input.id];
            if(stopCoord) {
                totalDist += getDist(currentPos, stopCoord);
                currentPos = stopCoord;
            }
        });
        totalDist += getDist(currentPos, allCoords.end);
        
        let finalPrice = totalDist < 5 ? 10 : 3 + (totalDist * 1.40);
        finalPrice += (stopInputs.length * 2);

        document.getElementById('pVal').innerText = Math.ceil(finalPrice) + " ‚Ç¨";
        document.getElementById('infoVal').innerText = totalDist.toFixed(1) + " KM | " + Math.round(totalDist * 2.5 + 5) + " MIN ENV.";
        document.getElementById('result').classList.remove('hidden');
    }

    function send() {
        const s = document.getElementById('startInput').value;
        const e = document.getElementById('endInput').value;
        const stopNames = Array.from(document.querySelectorAll('.stop-input')).map(i => i.value).filter(v => v !== "");
        const p = document.getElementById('pVal').innerText;
        const d = document.getElementById('infoVal').innerText;
        
        const waypoints = stopNames.join('|');
        // LIEN GPS CORRIG√â (SANS ERREUR DE SYNTAXE)
        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(s)}&destination=${encodeURIComponent(e)}&waypoints=${encodeURIComponent(waypoints)}&travelmode=driving`;

        let msg = `üöï *NOUVELLE R√âSA KLAK*\n\nüìç *D√âPART :* ${s}\n`;
        if(stopNames.length > 0) msg += `üõë *ARR√äTS :* ${stopNames.join(' -> ')}\n`;
        msg += `üèÅ *DESTINATION :* ${e}\nüìè *INFOS :* ${d}\nüí∞ *PRIX FIXE : ${p}*\n\nüõ∞Ô∏è *GPS :* ${mapsUrl}`;

        // Redirection vers le groupe
        window.open(`${lienGroupe}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function getLocation() {
        navigator.geolocation.getCurrentPosition(async (p) => {
            const res = await fetch(`https://api-adresse.data.gouv.fr/reverse/?lon=${p.coords.longitude}&lat=${p.coords.latitude}`);
            const data = await res.json();
            if(data.features[0]) {
                document.getElementById('startInput').value = data.features[0].properties.label;
                allCoords.start = data.features[0].geometry.coordinates;
            }
        });
    }
</script>

